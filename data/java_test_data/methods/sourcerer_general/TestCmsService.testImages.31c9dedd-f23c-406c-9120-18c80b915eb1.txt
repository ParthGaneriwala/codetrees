@Test
@DirtiesContext
public void testImages() {
    beginHttpSession();
    beginHttpRequestAndOpenSessionInViewFilter();
    CrudRootServiceHelper<DbCmsImage> crud = cmsService.getImageCrudRootServiceHelper();
    DbCmsImage dbCmsImage1 = crud.createDbChild();
    dbCmsImage1.setData(new byte[50000]);
    dbCmsImage1.setContentType("image");
    crud.updateDbChild(dbCmsImage1);
    endHttpRequestAndOpenSessionInViewFilter();
    endHttpSession();
    beginHttpSession();
    beginHttpRequestAndOpenSessionInViewFilter();
    Collection<DbCmsImage> collection = crud.readDbChildren();
    Assert.assertEquals(1, collection.size());
    Assert.assertEquals("image", collection.iterator().next().getContentType());
    Assert.assertEquals(50000, collection.iterator().next().getData().length);
    int id1 = collection.iterator().next().getId();
    endHttpRequestAndOpenSessionInViewFilter();
    endHttpSession();
    beginHttpSession();
    beginHttpRequestAndOpenSessionInViewFilter();
    cmsService.activateCms();
    endHttpRequestAndOpenSessionInViewFilter();
    endHttpSession();
    beginHttpSession();
    beginHttpRequestAndOpenSessionInViewFilter();
    DbCmsImage cachedImage = cmsService.getDbCmsImage(id1);
    Assert.assertEquals("image", cachedImage.getContentType());
    Assert.assertEquals(50000, cachedImage.getData().length);
    endHttpRequestAndOpenSessionInViewFilter();
    endHttpSession();
    beginHttpSession();
    beginHttpRequestAndOpenSessionInViewFilter();
    DbCmsImage dbCmsImage2 = crud.createDbChild();
    dbCmsImage2.setData(new byte[40000]);
    dbCmsImage2.setContentType("image2");
    crud.updateDbChild(dbCmsImage1);
    int id2 = dbCmsImage2.getId();
    endHttpRequestAndOpenSessionInViewFilter();
    endHttpSession();
    beginHttpSession();
    beginHttpRequestAndOpenSessionInViewFilter();
    cmsService.activateCms();
    endHttpRequestAndOpenSessionInViewFilter();
    endHttpSession();
    beginHttpSession();
    beginHttpRequestAndOpenSessionInViewFilter();
    cachedImage = cmsService.getDbCmsImage(id1);
    Assert.assertEquals("image", cachedImage.getContentType());
    Assert.assertEquals(50000, cachedImage.getData().length);
    cachedImage = cmsService.getDbCmsImage(id2);
    Assert.assertEquals("image2", cachedImage.getContentType());
    Assert.assertEquals(40000, cachedImage.getData().length);
    endHttpRequestAndOpenSessionInViewFilter();
    endHttpSession();
}

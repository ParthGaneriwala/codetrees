public void testGetState() throws Exception {
    long now = System.currentTimeMillis();
    String aor = "sip:alice@cipango.org";
    RegResource regResource = new RegResource(aor, null);
    // System.out.println(regResource.getState().getContent());
    Reginfo reginfo = ((ReginfoDocument) regResource.getState().getContent()).getReginfo();
    assertEquals(aor, reginfo.getRegistrationArray(0).getAor());
    assertEquals(State.INIT, reginfo.getRegistrationArray(0).getState());
    assertEquals(0, reginfo.getRegistrationArray(0).getContactArray().length);
    Registration registration = new Registration(aor);
    registration.addListener(regResource);
    Binding binding1 = new Binding(new UriImpl("sip:alice@localhost"), "123@localhost", 1, now + 100000);
    registration.addBinding(binding1);
    // System.out.println(regResource.getState().getContent());
    assertEquals(1, reginfo.getRegistrationArray(0).getContactArray().length);
    assertEquals(State.ACTIVE, reginfo.getRegistrationArray(0).getState());
    Contact contact = reginfo.getRegistrationArray(0).getContactArray(0);
    assertEquals(Event.REGISTERED, contact.getEvent());
    assertEquals("sip:alice@localhost", contact.getUri());
    // assertTrue(contact.getExpires().intValue() > 98 && contact.getExpires().intValue() <= 100);
    registration.addBinding(new Binding(new UriImpl("sip:alice@localhost:5070"), "567@localhost", 1, now + 200000));
    assertEquals(2, reginfo.getRegistrationArray(0).getContactArray().length);
    assertEquals(State.ACTIVE, reginfo.getRegistrationArray(0).getState());
    assertEquals(Event.REGISTERED, reginfo.getRegistrationArray(0).getContactArray(1).getEvent());
    assertEquals("sip:alice@localhost", reginfo.getRegistrationArray(0).getContactArray(0).getUri());
    assertEquals("sip:alice@localhost:5070", reginfo.getRegistrationArray(0).getContactArray(1).getUri());
    registration.updateBinding(binding1, new UriImpl("sip:alice@newContact"), "123@localhost", 1, now + 200000);
    assertEquals(2, reginfo.getRegistrationArray(0).getContactArray().length);
    assertEquals(State.ACTIVE, reginfo.getRegistrationArray(0).getState());
    assertEquals(Event.REFRESHED, reginfo.getRegistrationArray(0).getContactArray(0).getEvent());
    assertEquals(contact.getId(), reginfo.getRegistrationArray(0).getContactArray(0).getId());
    assertEquals("sip:alice@newContact", reginfo.getRegistrationArray(0).getContactArray(0).getUri());
    registration.removeBinding(binding1);
    assertEquals(1, reginfo.getRegistrationArray(0).getContactArray().length);
    assertEquals(State.ACTIVE, reginfo.getRegistrationArray(0).getState());
    registration.addBinding(binding1);
    registration.removeAllBindings();
    assertEquals(0, reginfo.getRegistrationArray(0).getContactArray().length);
    assertEquals(State.TERMINATED, reginfo.getRegistrationArray(0).getState());
}

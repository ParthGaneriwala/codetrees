protected boolean doExecute(Request req, ResponseGroup rg) throws ActionException, StaleDataException {
    try {
        RegisterRequest r = (RegisterRequest) req;
        logger.info("Register received: <name=" + r.getUser() + ", pwd=" + r.getPwd() + ">");
        Response rsp = new Response();
        User u = DaoUtil.getUserDao().getByName(r.getUser());
        if (u == null) {
            u = new User();
            u.setName(r.getUser());
            u.setPassword(r.getPwd());
            u = DaoUtil.getUserDao().save(u);
            req.setRequesterId(u.getId());
            rsp.setMessage(Resources.MSG_REGISTER);
            rsp.setName(Resources.RSP_SUCCESS);
            logger.info(LogUtil.logOp(u.getId(), LogUtil.OP_REGISTER, u.getName()));
            Response r2 = new Response();
            r2.setMessage(r.getUser());
            r2.setName(Resources.RSP_FORWARD);
            rg.setBroadcast(r2);
        } else {
            rsp.setMessage(Resources.MSG_ERROR_USER_EXISTED);
            rsp.setName(Resources.RSP_ERROR);
        }
        rg.setBack(rsp);
        return true;
    } catch (BeanPersistenceException e) {
        logger.warn("Couldn't register.", e);
        throw new ActionException("Register failed.", e);
    }
}
